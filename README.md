# Ускорение алгоритма Магма (ГОСТ 28147-89)

### Характеристики ноутбука
OS: Ubuntu 24.04.3 LTS

Процессор: AMD Ryzen 5 4000 series

gcc version 11.3.0

## Описание
Этот проект содержит две реализации алгоритма шифрования ["Магма" (ГОСТ 28147-89)](https://tc26.ru/standard/gost/GOST_R_3412-2015.pdf):

* **Скалярная версия** - классическая реализация на языке C взята из [linux-kernel](https://github.com/kuzcrypt/kuznyechik-kernel). Реализация находится в файле `magma.h`


* **SIMD версия** - оптимизированная реализация с использованием AVX2 инструкций для параллельной обработки 8 блоков данных
Реализация находится в файле `magma_simd.h`

Скалярная версия является уже достаточно оптимизированной, но все же есть возможность сделать её ещё быстрее.

1. Чтобы разогнать Магму, мы решили воспользоваться SIMD(AVX2). Ускорение было достигнуто засчёт конвеерной обработки сразу 8 блоков;

2. Также мы решили избавиться от некоторых вызовов функций, поскольку эта операция имеет некоторые накладные расходы, а еще аннотация функции `static inline` не всегда гарантирует подстановку кода функции в место ее вызова;

3. Еще одной мерой для ускорения работы Магмы было выравнивание адресов. Потому что интринсики из AVX2 работают быстрее с
выравненными адресами;

4. Мы провели исследование по выбору наиболее оптимальных флагов компиляции.

## Компиляция и запуск
```
gcc -mavx2 -O3 -march=native ./bench.c -o ./bench
./bench
```

## Немного про бенчмарк

Наш бенчмарк занимается сразу несколькими задачами. 

* проверяет работу функции раунда, сравнивая оптимизированную версию с исходной.

* проверяет корректность оптимизированного алгоритма шифрования, на случайно сгенерированном блоке, сравнивая с алгоритмом из linux-kernel.

* проводит тест производительности. Измеряет характеристики скалярного алгоритма и оптимизированного алгоритма. Для реализации
с интринсиками мы шифрует один и тот же блок 8 раз, на протяжение N-итераций.

Пример вывода бенчмарка:

```
=== ТЕСТ f и f_simd ФУНКЦИЙ ===
Тест 0: 0x01234567
  Скалярный f: 0xd6fac8f7
  SIMD f_simd: 0xd6fac8f7
  ✓ СОВПАДАЕТ

Тест 1: 0x89abcdef
  Скалярный f: 0x71c80a24
  SIMD f_simd: 0x71c80a24
  ✓ СОВПАДАЕТ

Тест 2: 0xfedcba98
  Скалярный f: 0xdabf7119
  SIMD f_simd: 0xdabf7119
  ✓ СОВПАДАЕТ

Тест 3: 0x76543210
  Скалярный f: 0x40ac6189
  SIMD f_simd: 0x40ac6189
  ✓ СОВПАДАЕТ

Тест 4: 0x00000000
  Скалярный f: 0xbe5b60c2
  SIMD f_simd: 0xbe5b60c2
  ✓ СОВПАДАЕТ

Тест 5: 0xffffffff
  Скалярный f: 0x65878938
  SIMD f_simd: 0x65878938
  ✓ СОВПАДАЕТ

Тест 6: 0x12345678
  Скалярный f: 0x42567393
  SIMD f_simd: 0x42567393
  ✓ СОВПАДАЕТ

Тест 7: 0x9abcdef0
  Скалярный f: 0xdf37e7d8
  SIMD f_simd: 0xdf37e7d8
  ✓ СОВПАДАЕТ


=== ТЕСТ ОДНОГО БЛОКА ===
Plaintext: 01 23 45 67 89 ab cd ef 

Скалярный ciphertext: 85 65 c8 c0 cd 6f 1a ca 
SIMD ciphertext (первый блок): 85 65 c8 c0 cd 6f 1a ca 

✓ Результаты совпадают!

Тест производительности:
Блок  0: 5e 10 1d 21 72 38 f6 49 
bytes_processed_scalar: 640000000.000000
speed_scalar: 0.44 Гбит/с
  Скалярный тест (1 блок за операцию):
    Итераций: 80000000
    Время: 11.551659006 сек
    Операций/сек: 6925412
    Время на операцию: 144.4 нс
Блок  0: 5e 10 1d 21 72 38 f6 49 
Блок  1: 5e 10 1d 21 72 38 f6 49 
Блок  2: 5e 10 1d 21 72 38 f6 49 
Блок  3: 5e 10 1d 21 72 38 f6 49 
Блок  4: 5e 10 1d 21 72 38 f6 49 
Блок  5: 5e 10 1d 21 72 38 f6 49 
Блок  6: 5e 10 1d 21 72 38 f6 49 
Блок  7: 5e 10 1d 21 72 38 f6 49 
bytes_processed_simd: 640000000.000000
speed_simd: 0.95 ГБит/с
  Минимальный SIMD тест (8 блоков за операцию):
    Итераций: 10000000
    Время: 5.400076663 сек
    Операций/сек: 1851826
    Время на операцию: 540.0 нс

Speedup: 2.139166
```


## Результаты измерений

Gost engine:
```
Doing gost89 for 10s on 16 size blocks: 12989906 gost89's in 9.96s
Doing gost89 for 10s on 64 size blocks: 3334831 gost89's in 9.96s
Doing gost89 for 10s on 256 size blocks: 864734 gost89's in 9.97s
Doing gost89 for 10s on 1024 size blocks: 210879 gost89's in 9.97s
Doing gost89 for 10s on 8192 size blocks: 25982 gost89's in 9.96s
Doing gost89 for 10s on 16384 size blocks: 13322 gost89's in 9.94s
version: 3.0.17
built on: Fri Sep 26 18:59:22 2025 UTC
options: bn(64,64)
compiler: gcc -fPIC -pthread -m64 -Wa,--noexecstack -Wall -fzero-call-used-regs=used-gpr -DOPENSSL_TLS_SECURITY_LEVEL=2 -Wa,--noexecstack -g -O2 -ffile-prefix-map=/build/reproducible-path/openssl-3.0.17=. -fstack-protector-strong -Wformat -Werror=format-security -DOPENSSL_USE_NODELETE -DL_ENDIAN -DOPENSSL_PIC -DOPENSSL_BUILDING_OPENSSL -DNDEBUG -Wdate-time -D_FORTIFY_SOURCE=2
CPUINFO: OPENSSL_ia32cap=0x7ffaf3bfffebffff:0x18c05fdef3bfa7eb
The 'numbers' are in 1000s of bytes per second processed.
type             16 bytes     64 bytes    256 bytes   1024 bytes   8192 bytes  16384 bytes
gost89           20867.32k    21428.63k    22203.80k    21658.99k    21369.93k    21958.52k
```

| Метод | Скорость | Время |
|-------|----------|-------|
| Скалярная версия | 0.44 Гбит/с | 11.66 сек |
| SIMD версия | 0.95 Гбит/с | 5.39 сек |

**Вывод**: SIMD оптимизация ускоряет шифрование **в ~2.16 раза**.


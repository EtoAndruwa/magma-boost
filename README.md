# Ускорение алгоритма Магма (ГОСТ 28147-89)

### Характеристики ноутбука
OS: Ubuntu 24.04.3 LTS

Процессор: AMD Ryzen 5 4000 series

gcc version 11.3.0

## Описание
Этот проект содержит две реализации алгоритма шифрования ["Магма" (ГОСТ 28147-89)](https://tc26.ru/standard/gost/GOST_R_3412-2015.pdf):

* **Скалярная версия** - классическая реализация на языке C взята из [linux-kernel](https://github.com/kuzcrypt/kuznyechik-kernel). Реализация находится в файле `magma.h`


* **SIMD версия** - оптимизированная реализация с использованием AVX2 инструкций для параллельной обработки 8 блоков данных
Реализация находится в файле `magma_simd.h`

Скалярная версия является уже достаточно оптимизированной, но все же есть возможность сделать её ещё быстрее.

1. Чтобы разогнать Магму, мы решили воспользоваться SIMD(AVX2). Ускорение было достигнуто засчёт конвеерной обработки сразу 8 блоков;

2. Также мы решили избавиться от некоторых вызовов функций, поскольку эта операция имеет некоторые накладные расходы, а еще аннотация функции `static inline` не всегда гарантирует подстановку кода функции в место ее вызова;

3. Еще одной мерой для ускорения работы Магмы было выравнивание адресов. Потому что интринсики из AVX2 работают быстрее с
выравненными адресами;

4. Мы провели исследование по выбору наиболее оптимальных флагов компиляции.

## Компиляция и запуск
Build:
```
make bench
```

Build and run:
```
make run
```

## Немного про бенчмарк

Наш бенчмарк занимается сразу несколькими задачами. 

* проверяет работу функции раунда, сравнивая оптимизированную версию с исходной.

* проверяет корректность оптимизированного алгоритма шифрования, на случайно сгенерированном блоке, сравнивая с алгоритмом из linux-kernel.

* проводит тест производительности. Измеряет характеристики скалярного алгоритма и оптимизированного алгоритма. Для реализации
с интринсиками мы шифрует один и тот же блок 8 раз, на протяжение N-итераций.

Пример вывода бенчмарка:

```
=== Тест f и f_simd функций ===
Тест 0: 0x01234567
  Скалярный f: 0xd6fac8f7
  SIMD f_simd: 0xd6fac8f7
  ✓ СОВПАДАЕТ

Тест 1: 0x89abcdef
  Скалярный f: 0x71c80a24
  SIMD f_simd: 0x71c80a24
  ✓ СОВПАДАЕТ

Тест 2: 0xfedcba98
  Скалярный f: 0xdabf7119
  SIMD f_simd: 0xdabf7119
  ✓ СОВПАДАЕТ

Тест 3: 0x76543210
  Скалярный f: 0x40ac6189
  SIMD f_simd: 0x40ac6189
  ✓ СОВПАДАЕТ

Тест 4: 0x00000000
  Скалярный f: 0xbe5b60c2
  SIMD f_simd: 0xbe5b60c2
  ✓ СОВПАДАЕТ

Тест 5: 0xffffffff
  Скалярный f: 0x65878938
  SIMD f_simd: 0x65878938
  ✓ СОВПАДАЕТ

Тест 6: 0x12345678
  Скалярный f: 0x42567393
  SIMD f_simd: 0x42567393
  ✓ СОВПАДАЕТ

Тест 7: 0x9abcdef0
  Скалярный f: 0xdf37e7d8
  SIMD f_simd: 0xdf37e7d8
  ✓ СОВПАДАЕТ


=== Тест одного блока ===
Plaintext: fe dc ba 98 76 54 32 10 

Скалярный ciphertext: 58 b9 a0 63 38 21 9d 9c 
SIMD ciphertext (первый блок): 58 b9 a0 63 38 21 9d 9c 

✓ Результаты совпадают!
=== Тест одного блока ===

=== Тест производительности ===

Блок  0: a1 f1 7a d7 dc bd d0 92 
  Скалярный тест (1 блок за операцию):
    Итераций: 80000000
    Время: 11.044714599 сек
    Операций/сек: 7243284
    Время на операцию: 138.1 нс
    Скорость скалярной реализации: 0.46 Гбит/с

Блок  0: a1 f1 7a d7 dc bd d0 92 
Блок  1: a1 f1 7a d7 dc bd d0 92 
Блок  2: a1 f1 7a d7 dc bd d0 92 
Блок  3: a1 f1 7a d7 dc bd d0 92 
Блок  4: a1 f1 7a d7 dc bd d0 92 
Блок  5: a1 f1 7a d7 dc bd d0 92 
Блок  6: a1 f1 7a d7 dc bd d0 92 
Блок  7: a1 f1 7a d7 dc bd d0 92 
  Минимальный SIMD тест (8 блоков за операцию):
    Итераций: 10000000
    Время: 5.390710281 сек
    Операций/сек: 1855043
    Время на операцию: 539.1 нс
    Скорость SIMD реализации: 0.95 ГБит/с

Ускорение относительно реализации из linux-kernel: 2.048842
Ускорение относительно реализации из gost-engine: 4.317191
```


## Результаты измерений

Gost engine:
```
The 'numbers' are in 1000s of bytes per second processed.
type             16 bytes     64 bytes    256 bytes   1024 bytes   8192 bytes  16384 bytes
gost89           20867.32k    21428.63k    22203.80k    21658.99k    21369.93k    21958.52k
```

| Метод | Скорость | Время |
|-------|----------|-------|
| Скалярная версия | 0.44 Гбит/с | 11.66 сек |
| SIMD версия | 0.95 Гбит/с | 5.39 сек |

### Вывод:

Ускорение относительно реализации из linux-kernel: 2.1  
Ускорение относительно реализации из gost-engine: 4.3

